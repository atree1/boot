<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/shopLayout}">

<div class="container" style="margin-top: 20px;"
	layout:fragment="container">
	<style>
	.orderInfo{
		padding:7px 0;
		font-size:14px;
	}
	</style>
	<div class="shoppingBasketArea" style="">
		<div class="displayTable" style="height: 65px;">
			<tbody id="basketAllTable">
				
				<div style="margin:20px 0;">
					
					<span style="font-size:38px;">주문결제</span><br/>
					
					<hr>
				</div>
				
				<div style="margin:40px 0 10px 10px; font-size:21px; font-weight:bold">주문 정보 확인</div>
				<div style="display: inline-block; width: 760px">

					<div style="border-bottom: 4px solid #e5e5e5; width: 760px;"></div>
						<div th:each="arr: ${orderList}">
							

							<table cellspacing="0" class="goods basketGoodsTableMiddle"
								storeindex="0" storesid="4488" style="width: 760px;">
								<tbody>
									<tr style="height: 120px;" th:id="|option_${arr.option.opno}|">
										<td class="checkBoxTd borderBottom">
											<div class="check_box">
												<input type="checkbox"></label>
											</div>
										</td>
										<td class="height90 borderBottom " colspan="4"
											style="text-align: left; width: 150px;">
											<div class="shoppingGoodsThumbnail">
												<img th:class="|thumb_${arr.pno}|"
													style="width: 60px; display: inline-block; vertical-align: middle;">
											</div>
											<div
												style="display: inline-block; margin-left: 6px; vertical-align: middle;">
												<div class="basketGoodsName" style="width: 100px;">
													<a class="modalOpen" style="color: #333;"
														th:text="${arr.product.pname}"></a>
													<div class="basketGoodsDeleteBtn"></div>
												</div>
												<div class="basketStoreInfo"
													style="font-size: 15px; margin-top: 6px;"
													th:text="|사이즈 / ${arr.option.size}|">SIZE</div>
											</div>
										</td>
										<td class="borderRight" colspan="5"
											style="border-spacing: 0px;">
											<table cellspacing="0" style="width: 100%;">
												<tbody>
													<tr class="height60 optionClass">

														<td class=" upDownTd">
															<div class="upDownDiv">

																<input class="upDownNumArea" type="text" name="price"
																	th:value="|${arr.qty}개|" placeholder="0"
																	style="ime-mode: disabled;">
															</div>
														</td>
													</tr>
												</tbody>
											</table>
										</td>

										<td class="basketGoodsSumPrice"><span
											th:id="|price_${arr.option.opno}|"
											th:class="|sumPrice pno_${arr.option.pno}|"
											th:data-price="${arr.product.price*arr.qty}"
											th:text="${arr.product.price*arr.qty}">PRICE </span><strong>원</strong>
										</td>
									</tr>

								</tbody>
							</table>
						</div>
						<div style="border-bottom: 4px solid #e5e5e5; width: 760px;"></div>
						
						<div style="margin:40px 0 10px 10px; font-size:21px; font-weight:bold">내 정보 확인</div>
						<table id="payMethodTable_0" class="basketGoodsTableEnd"
							cellspacing="0" style="width: 760px;  border-top: 4px solid #e5e5e5;">
							
							<tbody>
						
								<tr class="paymentOption" style="height: 102px;">
								
									<td class="" colspan="6"
										style="padding: 0 30px; border-spacing: 10px;">
										
										<div class="payMethodInputArea" style="height: 54px;">
											<div class="orderInfo"><strong  th:text="${member.mname}">NAME</strong></div>
											<div class="orderInfo" th:text="${member.address}">Address</div>
											<div class="orderInfo" th:text="${member.pnum}" style="color:#9b9b9b">전화번호</div>
											<input class="payMethodInput" type="text"
												placeholder="배송시 요청사항을 입력해주세요(선택)" 
												style="width: 600px; height: 32px; box-sizing: border-box; padding: 0px 9px; margin-top: 7px;">
										</div>
										
									</td>
								</tr>
							</tbody>
						</table>
						
						<div style="margin:40px 0 10px 10px; font-size:21px; font-weight:bold">결제수단 선택</div>
						<table id="payMethodTable_0" class="basketGoodsTableEnd"
							cellspacing="0" style="width: 760px;">
							
							<tbody>
								<tr id="payMentStore_0"
									class="paymentOption height60 payMethodTR">
									
									<td id="storePayMethod_0" class="textLeft storeLengthCount"
										colspan="5" style="border-spacing: 10px; 
										padding: 0px 30px; border-top: 4px solid #e5e5e5;">
										
										<button id="payDirect_0" class="basketSwapBtn">카카오페이</button>

									</td>
								</tr>
							</tbody>
						</table>
					
					<table style="padding: 0px 34px;">
						<tbody>
							<tr>
								<td colspan="6"
									style="padding: 30px 0px 40px 0px; width: 760px;">
									<div class="cart">
										주문하기는 <span style="color: #ff5252; font-weight: bold;">선택된 상품 및 옵션</span>
										만 주문되고 선택되지 않은 상품은 장바구니에 남아 있습니다.<br>
										주문하는 시점에 품절되어 있는 상품은 주문되지 않고 장바구니에 남아있습니다.
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div id="changePriceArea" class="floatArea" style="height: 1585px;">
					<div class="floatMenu" style="">
						<table class="buyNPriceTable" cellspacing="0"
							style="width: 100%; color: #202225;">
							<tbody>
								<tr>
									<td colspan="2" style="">
										<button class="formBuyNPriceInfoBoxTitle">결제예정 금액</button>
									</td>
								</tr>
								<tr>
									<td class="floatTableText" style="">배송비</td>
									<td class="floatTableNumber" style="text-align: right;"><span
										class="d_deliveryPrice">3000</span>원</td>
								</tr>
								<tr>
									<td class="floatTableText" style="">물품 금액</td>
									<td class="floatTableNumber" style="text-align: right;"><span
										class="d_goodsSumPrice"></span>원</td>
								</tr>
								<tr>
									<td class="floatTableText"
										style="border-bottom: 1px solid #e1e1e1;">총 주문금액</td>
									<td class="floatTableNumber"
										style="border-bottom: 1px solid #e1e1e1; text-align: right; color: #ff5252;"><span
										class="d_totalPrice">0</span>원</td>
								</tr>
								<tr>
									<td colspan="2" style="height: 10px;"></td>
								</tr>
								<tr>
									<td colspan="2">
										<button class="orderBtn"
											style="background-color: #ff7f7a; border: 1px solid #ff7f7a;">
											결제하기</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>

				</div>

			</tbody>
			<div id="basketSSCTitle" style="display: none; padding: 30px 0px;">
				<img src="../img/bg_cart_ssc_title_banner_01.png"
					style="width: 100%;">
			</div>
		</div>
	</div>

</div>
<th:block layout:fragment="script">
	<script th:inline="javascript">
	$(document).ready(function(){
		
	    var list = [[${orderList}]];
		
		var totalCount = $(".optionPrice").data("price");
		var sum = 0;
		
		(function(){
			
			getTotalSum();
			
			$.each(list, function(index, item){
				var sum = 0;
				
				$.makeArray($(".sumPrice").map(function(){
					if($(this).hasClass("pno_"+item.pno)){
						sum += $(this).data("price");
					}
					
				}));
				
				var img =  item.product.imgList[0];
				var fileCallPath =  encodeURIComponent(img.ipath+ "/s_"+ img.uuid +"_"+img.iname);
				
				$.each($('.thumb_'+ item.pno),function(){
					$(this).attr("src","/display?fileName="+fileCallPath); 
				});
				
				$("#sumText_"+item.pno).html(sum);
				
			});
		})();
		
		
		$(".orderBtn").on('click',function(e){
			e.preventDefault();
			
			 $.ajax({
                type:"post",
                data : JSON.stringify(list),
                url: "/kakaopay/pay",
                contentType : "application/json; charset=UTF-8",
                success:function(result, status, xhr){
                	popupOpen(result);
    			}
            }); 
			
		});
		
		function popupOpen(popUrl){

			var popOption = "width=400, height=500, resizable=no, scrollbars=no, status=no;";    //팝업창 옵션(optoin)
			window.open(popUrl,"",popOption);

		}

		function getTotalSum(){
			$.makeArray($(".sumPrice").map(function(){
				sum += $(this).data("price");
			}));
			$(".d_goodsSumPrice").html(sum);
			$(".d_totalPrice").html(sum + 3000);
		}
		
		$(".downArea").click(function(e) {
			var count = $(this).next("input").val();
			if (count > 1) {
				count -= 1;
				$(this).next("input").val(count);
			}
			
		});

		$(".upArea").click(function(e) {
			
			var count = Number($(this).prev("input").val());
			var opno = $(this).attr("id").substring(3);
			$.each(list,function(index, item){
				if(item.opno = opno){
					
				}
			});
			count += 1;
			$(this).prev("input").val(count);

		});
	
		
	});
	</script>
</th:block>
</html>