<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/shopLayout}">


<style>
.inner_main_img img{
	width:540px;
	height:80px;
}
.gthumb img{
width:40px;
	height:10px;
}


</style>

<div class="container" style="margin-top: 20px;"
	layout:fragment="container">
	<div class="menuRoot">
		<div class="table-cell" style="">
			<span class="bigCategoryName" style="color: #9b9b9b; margin-right:10px;">여성의류</span>
			<span class="detailCategoryName" style="color: #9b9b9b; margin-right:10px;">> 티 & 탑</span>
			<span class="selectedMypageMenu selectedGoodsNameInner">
				> 양면기모 레터링맨투맨(주문폭주, 리오더폭발)</span>
		</div>
	</div>

	<div class="innerDetail_goods_info" style="padding-bottom: 50px;">
		<div class="img_area"
			style="border-right: 1px solid rgb(221, 221, 221);">
			<div class="gthumbs" style="height: 720px; overflow-y: auto;">
				
			</div>
			<div style="line-height:200px">
				<img width="540" style="vertical-align:middle;" class="inner_main_img" src="">
			</div>
			<div id="innerDetail_goods_detail" class="goods_detail">
				<div class="div_line_1px" style="width: 632px; margin-right: 20px;"></div>
				<div class="goods_detail_title displayTable">
					<div class="table-cell">제품 상세설명</div>
				</div>
				<div class="goods_detail_text">
					설명설명
				</div>
				
				<!--댓글  -->
				<div class="goods_comments_area">
					<div id="replySelector" name="goods_comment_title"
						class="goods_comment_title displayTable">
						
						<div class="table-cell" id="review" data-kind='R'>
							리뷰 
							<span class="innerRepleTotalCount" th:text="${product.ReviewReplyCnt}"
								style="color: #9b9b9b; font-size: 14px; font-weight: normal; vertical-align: top;">(0)</span>
						</div>
						<div class="table-cell" id="question" data-kind="Q">
							상품문의
							<span class="innerRepleTotalCount" th:text="${product.QuestionReplyCnt}"
								style="color: #9b9b9b; font-size: 14px; font-weight: normal; vertical-align: top;">(0)</span>
						</div>
					</div>
					
					<div id="replyAdd" class="replyContainer">
					<div>
						<input type="text" name="title" style="width: 100%; height: 30px;" placeholder="제목을 입력해주세요.">
					</div>
						<div>
						<input type="text" name="mid" style="width: 100%; height: 30px;" placeholder="작성자.">
					</div>
					
						<div class="
						star">
						<select class="score">
  						<option th:value="1">★</option>
  						<option th:value="2">★★</option>
 						<option th:value="3">★★★</option>
  						<option th:value="4">★★★★</option>	
  						<option th:value="5">★★★★★</option>
						</select>
						</div>
							
						<div 					
					class="goods_comment_input" style="position: relative; box-sizing: border-box; border: 1px solid #e3e3e3; height: 150px;">
						<input id="innerCommentMsg" name="content" class="replyTextarea" placeholder="덧글을 입력해주세요." style="width: 100%; height: 100px;">
						<button class="repleRegiBtn" >등록하기</button>
					</div>
					</div>
					
					<ul id="inner_goods_comments"  class="inner_goods_comments" style="position: relative;">
					
					</ul>
					<!--페이지 -->
					<div class="replyPageFooter" style="text-align: center;">
						
					</div>
					
				</div>
			</div>
		</div>
		<div class="info_area">
			<div class="info_area_inner"
				style="margin-left: 18px; position: relative;">
				<div class="more_goods">
					<div class="goods_name" th:text="${product.pname}">PNAME</div>
					<div class="detail_store_name">
						<span class="store" th:text="${store.saddress}">ADDRESS</span>
						 <span th:text="${store.tel}">TEL<span>
					</div>
					<div class="goods_price" th:text="${product.price}">PRICE</div>
					<div class="div_line_1px" style="width: 100%; margin-bottom: 30px;"></div>
					<table class="goods_option_table" style="margin-bottom: 30px;">
						<tbody>
							<tr>
								<td class="title">색상</td>
								<td class="color">오트밀 차콜그레이</td>
							</tr>
							<tr>
								<td class="title">혼용률</td>
								<td class="content">면</td>
							</tr>
							<tr>
								<td class="title">제조국</td>
								<td class="content">대한민국</td>
							</tr>
						</tbody>
					</table>
					<div class="div_line_1px" style="width: 100%; margin-bottom: 21px;"></div>
					<table class="goods_option_table" style="margin-bottom: 30px;">
						<tbody>
							<tr>
								<td class="title" style="color: #ff7675;">신상배송</td>
								<td class="content">카카오 결제만 가능, 택배배송<span
									style="color: #b0b0b0;">(우체국택배)</span></td>
							</tr>
						</tbody>
					</table>
						<div class="div_line_1px" style="width: 100%; margin-bottom: 21px;"></div>
						<div class="option_area">
							<ul class="goods_option_ul" style="width: 100%;" th:each="arr:${product.optList}">
								<li class="min-height42 optionLi">
									
									<div class="option">
										<div th:name="${arr.opno}" th:data-size="${arr.size}" style="color: #333; font-weight: 500; font-size: 14px;" 
										th:text="|SIZE / ${arr.size}|">SIZE</div>
										<div style="margin-top: 6px; font-size: 12px;"
											th:text="|재고수량 / ${arr.qty}|">QTY</div>
									</div>
									
									<div class="count">
										<div class="option_count_control" style="">
											<div class="detailUpDownDiv">
												<div class="detailDownArea"></div>
												<input name="option" th:id="${arr.opno}" class="detailUpDownNumArea" type="text"
													value="0">
												<div class="detailUpArea"></div>
											</div>
										</div>
									</div>
								</li>
							</ul>
							<div class="div_line_1px"
								style="width: 100%; margin-top: 20px; margin-bottom: 15px;"></div>
						</div>
				
						<input type="hidden" name="pno" th:value="${product.pno}">
						<input type="hidden" name="mid" value="member1">
					
						<div class="displayTable"
							style="width: 100%; background-color: #ffefef; height: 50px; padding: 0px 16px; box-sizing: border-box; margin-bottom: 15px;">
							<div id="selectResult" class="table-cell"></div>
							<div class="table-cell" style="font-size: 14px;">총 결제금액</div>
							<div class="detailOrderPrice table-cell"
								style="text-align: right; font-size: 20px; color: #ff5252; font-weight: 500;">
								<span class="totalSum">0</span>원
							</div>
						</div>

						<div class="btn_area">
							<div style="position:relative">
							<div class="basketInfoTextBox basketMoveBox"
								style="position: absolute; left: 111px; top: -106px; width: 318px; height: 100px; z-index: 3; display:none">
								<div class="close_btn"
									style="position: absolute; right: 8px; top: 8px;"></div>
								<div
									style="text-align: center; font-size: 14px; margin-top: 16px; font-weight: bold; letter-spacing: -0.4px;">
									장바구니에 상품이 담겼습니다.<br>
									<button class="basketMoveBtn" onclick="goShoppingBasket()"
										style="margin-top: 14px; height: 38px; cursor: pointer;">
										장바구니 바로가기 <span class="btn_css_arrow"></span>
									</button>
								</div>
							</div>
							<button class="btn_order" style="display: inline-block;">장바구니에
								담기</button>
							</div>
							<button class="btn_order_direct" style="display: inline-block;">
								<div class="symbolLogo"></div>
								주문하기
							</button>
							
						</div>
				
				</div>
				<div class="div_line_1px"></div>
				<div class="mgoods_images">

				</div>
			</div>
		</div>
			
	</div>
	<form action="/order/list" id="storeDetailForm" method="get" >
		<input type="hidden" name="mid" value="member1"/>
		<input type="hidden" name="sno" value="1"/>
	</form>
</div>

<th:block layout:fragment="script">
<script th:inline="javascript" th:src="@{../js/reply.js}"></script>
<script th:inline="javascript">
	$(document).ready(function() {
		
		var pageNum = 1;
		var replyPageFooter = $(".replyPageFooter");
		
		var pnoValue =  [[${product.pno}]];
		var replyUL = $("#inner_goods_comments");
		var kindValue = "Q"; 
		var parent = 0;
		
		var replyAdd = $("#replyAdd");
		var InputTitle = replyAdd.find("input[name='title']");
		var InputContent=replyAdd.find("input[name='content']");
		var InputMid=replyAdd.find("input[name='mid']");
		
		var replyContainer =$(".replyContainer").clone(true);
		var modifyTitle ;
		var modifyContent;
		var modifyMid;
		var modifyRno;
		var modifyScore;
		showList(1);
		
		var scoreValue = $(".score option:selected").val();
	
		//Question 별점숨김.
		$(".goods_comments_area").on("click","div [data-kind]",function(e){
			
			var kind=$(this).data("kind");
			
			if(kind =='Q'){
				$(".star").hide();
			}
			else{
				$(".star").show();	
			}
			
		});
		
		//댓글페이지 출력
		function showReplyPage(replyCnt){
			
			var endNum = Math.ceil(pageNum/10.0)*10;
			var startNum = endNum - 9;
			
			var prev = startNum != 1;
			var next = false;
			
			if(endNum*10>=replyCnt){
				endNum=Math.ceil(replyCnt/10.0);
			}
						
			if(endNum*10 <replyCnt){
				next=true;				
			}
			
			var str="<ul><li>";
			
			if(prev){
				str+="<li><a href='"+(startNum-1)+"'>Previous</a></li>";
			}
			
			for(var i=startNum; i<=endNum; i++){
				var active= pageNum ==i?"active":"";
				
				str+="<li class='"+active+"'><a href='"+i+"'>"+i+"</a></li>";
			}
			
			if(next){
				str+="<li><a href='"+(endNum+1)+"'>Next</a></li>";
			}
			str+="</li></ul>";
			console.log(str);
			replyPageFooter.html(str);
		}
		
		replyPageFooter.on("click","li a",function(e){
			
			e.preventDefault();
			var targetPageNum = $(this).attr("href");
			
			pageNum=targetPageNum;
			
			showList(pageNum);
		});
		
		//수정하기 조회
		$(".inner_goods_comments").on("click",".modifyBtn",function(e){
			
		 	 modifyTitle = replyContainer.find("input[name='title']");
			 modifyContent=replyContainer.find("input[name='content']");
			 modifyMid=replyContainer.find("input[name='mid']");
			 modifyScore=replyContainer.find(".score option:selected").parent();
			 
			console.log("mod clicked.......");
			modifyRno=$(this).data("rno");
			
			$(this).parent().append(replyContainer.show());

			replyService.get(modifyRno,function(reply){
				
				modifyTitle.val(reply.title);
				modifyContent.val(reply.content);
				modifyMid.val(reply.mid).attr("readonly","readonly");
				modifyScore.val(reply.score);
				replyContainer.find('button').text("수정하기").attr("class","modBtn");
			});
							
		});
		
		//수정 replyContainer
		    $(document).on("click",".modBtn",function(e){
			
			console.log("mod");
			
			var reply ={
					
					rno : modifyRno,
					title:modifyTitle.val(),
					content:modifyContent.val(),
					score:modifyScore.val(),
					kind:kindValue
			};
			
			replyService.update(reply,function(result){
				alert(result);
				showList(pageNum);
			});
			
		});
		
		//삭제
		$(".inner_goods_comments").on("click",".deleteBtn",function(e){
			
			console.log("clicked....");
			
			var rno = $(this).data("rno");
		
			replyService.remove(rno,function(result){
				console.log(rno);
				alert(result);
				showList(pageNum);		
			});
			
			var cnt=$("div [data-kind='"+kindValue+"']").find("span ");

			showList(1);
			cnt.text(parseInt(cnt.text())-1);
		});
		
		//댓글등록
		$(".repleRegiBtn").on("click",function(e){
			

			if($(".replyTextarea")[0].textLength === 0){
				alert("덧글을 입력해주세요");	
				return;
			}
			
			var reply ={					
					pno:pnoValue,
					mid: InputMid.val(),
					content: InputContent.val(),
					title: InputTitle.val(),
					kind: kindValue,
					parent: ++parent,
					depth:0,
					score:scoreValue
						};
			
			replyService.add(reply, function(result){
				alert(result);
				replyAdd.find("input").val("");
				
				var cnt=$("div [data-kind='"+kindValue+"']").find("span ");
	
		
				showList(1);
				cnt.text(parseInt(cnt.text())+1);
								
			});
			
		});
		
		
		
		$("#replySelector").on("click","div",function(e){
			
			var kind=$(this).data("kind");
			console.log(kind);
			kindValue=kind;
			showList(1);
		
		});
		
		//리스트
		function showList(pageNum){
			
			replyService.getList({pno:pnoValue, page:pageNum, kind:kindValue}, function(replyCnt,parentCnt,list){
								
				/* console.log("replyCnt:"+replyCnt);
				
				console.log("pageNum:"+pageNum); */
				console.log(list);
				if(pageNum == -1){
					pageNum= Math.ceil(replyCnt/10.0);
					console.log("pageNum:"+pageNum);
					showList(pageNum);
					return;
				}
				
				
				var str ="";
				if(list == null || list.length == 0){
					replyUL.html("");
					return;
				}
				
				for(var i=0, len = list.length ||0; i<len; i++){
					console.log(list[i]);
					str +="<li class='g_comment_li' data-rno='"+list[i].rno+"'>";
					
					if(list[i].depth==1){
						str+="<div class='store_name ellipsis wstore_name' style='margin-left:30px'>"+list[i].mid+"</div>";
					}else{
						str +="<div class='store_name ellipsis wstore_name'>"+list[i].mid+"</div>";
					}					
					str +="<div class='datetime ellipsis'>"+list[i].regdate+"</div>";
					str +="<button class='modifyBtn' data-rno='"+list[i].rno+"'>수정</button><button class='deleteBtn' data-rno='"+list[i].rno+"'>삭제</button>"
					str +="<div class='title' style='margin-top: 17px; padding-bottom: 15px;'>"+list[i].title;
					if(list[i].kind =="Q"){
						str+="";
					}else{
					str +="<div class='score'>"+list[i].score+"<div>"
					}
					str +="<div class='content'><div class='qAnswerLogo'></div><div class='qAnswer'>"+list[i].content+"</div></div>";
					str +="</div></li>";
				}
				
				
				replyUL.html(str);
				parent = parentCnt;
				showReplyPage(replyCnt);
				
			});
		}
		

		var actionForm = $("#storeDetailForm");
	    var product = [[${product}]];
	    var store = [[${store}]];
	   
		(function() {
			setImg();
		})();
		
		function setImg(){
			
			var imgList=[[${product.imgList}]];
			var str="";
			var fileCallPath =  encodeURIComponent(imgList[0].ipath+ "/"+ imgList[0].uuid +"_"+imgList[0].iname);
			$(".inner_main_img").attr("src","/display?fileName="+fileCallPath);
			
			for(img of imgList){
				
				var thumbFileCallPath =  encodeURIComponent(img.ipath+ "/s_"+ img.uuid +"_"+img.iname);

				str += "<div class='gthumb'>"
				str += "<img width='60' src='/display?fileName="+
						thumbFileCallPath+"' style='display:block;'>"
				str += "<span class='img_edge'></span></div>"
		
			}
			
			$(".gthumbs").html(str);
		}
		
		$(".btn_order").on('click',function(e){
			e.preventDefault();
			var jsonList = new Array();
			
			$.each($(".detailUpDownNumArea"), function(index, item){
				if($(this).val() !=0){
					var list = {
							"mid" : "test",
							"pno" : product.pno,
							"qty" : $(this).val(),
							"opno" : $(this).attr("id"),
							"sno" : store.sno
					}
					
					jsonList.push(list);
				}
				
			}); 

			if(jsonList.length != 0){
				 $.ajax({
		                type:"post",
		                data : JSON.stringify(jsonList),
		                url: "/cart/new",
		                contentType : "application/json; charset=UTF-8",
		                success:function(result, status, xhr){
		                	console.log(result);
		    			}
		            }); 
					 
					 $(".basketInfoTextBox").css("display", "block");
					 
			}else{
				alert("수량을 입력해주세요.")
			}
			
		});
		
		
		$(".detailDownArea").click(function(e) {
			var count = $(this).next("input").val();
			if (count > 0) {
				count -= 1;
				$(this).next("input").val(count);
			} else {
				$('html').css({
					'cursor' : 'url(cursor.png), auto'
				});
			}
			totalSum();
		})

		$(".detailUpArea").click(function(e) {

			var count = Number($(this).prev("input").val());
			count += 1;
			$(this).prev("input").val(count);
			totalSum();
		})

		$(".gthumbs").on("mouseenter",".gthumb", function(e) {
			$(this).find("span").attr("class", "hover");
			var src = $(this).find("img").attr("src");
			$(".inner_main_img").attr("src", src);
		}).mouseout(function() {
			$(this).find("span").attr("class", "img_edge");
			setImg();
		})

		$(".close_btn").click(function(e) {
			$(".basketInfoTextBox").css("display", "none")
		});
		
		
		
		
		$(".btn_order_direct").click(function(){
			$.each(product.optList, function(index, item){
				var value = $("#"+item.opno+"").val();
				if(value > 0){
					actionForm.append("<input type='hidden' name='info' id='info' value='"
							+item.pno+"_"+item.opno+"_"+value+"_"+store.sno+"'>");
					
				}
			});
			actionForm.append("<input type='hidden' name='sno' value='"+store.sno+"'>");
			if($("#info").val() == null){
				alert("수량을 입력해 주세요");
			}else{
				actionForm.submit();
			}
			
		});
		
		function totalSum(){
			var totalSum = 0;
			$(".detailUpDownNumArea").each(function(index, item){
				totalSum += Number(product.price * item.value);
			});
			
			$(".totalSum").html(totalSum);
		}
	});
</script> 
</th:block>

</html>